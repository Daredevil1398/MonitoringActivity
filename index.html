<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ë–õ–ê–ù–ö –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É v7.4 FULL (Word + HTML)</title>
    <script src="https://cdn.jsdelivr.net/npm/docx@7.1.0/build/index.js"></script>
    <style>
        :root { --primary: #4a90e2; --success: #2ecc71; --danger: #e74c3c; --warning: #f1c40f; --dark: #2c3e50; --bg: #f0f2f5; --border: #dcdde1; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); margin: 0; padding: 0; }
        .container { max-width: 1100px; margin: 0 auto; padding: 15px; }
        .card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 20px; }
        h1 { text-align: center; color: #2c3e50; font-size: 1.6rem; }
        .status-indicator { text-align: center; padding: 10px; border-radius: 10px; margin-bottom: 15px; font-weight: bold; }
        .status-on { background: #e8f5e9; color: #2e7d32; }
        .status-off { background: #ffebee; color: #c62828; }
        .control-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .btn { padding: 15px; border: none; border-radius: 12px; font-weight: 700; color: white; cursor: pointer; font-size: 15px; }
        .btn-blue { background: var(--primary); }
        .btn-orange { background: var(--warning); color: #333; }
        .btn-red { background: var(--danger); }
        input, textarea { width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        .main-table { width: 100%; border-collapse: collapse; background: white; table-layout: fixed; min-width: 900px; }
        .main-table td, .main-table th { border: 1px solid #ccc; padding: 8px; vertical-align: middle; text-align: center; }
        textarea.activity-box { height: 50px; resize: vertical; }
        .num-input { width: 45px; height: 35px; text-align: center; font-weight: bold; border-radius: 8px; border: 1px solid #ddd; }
    </style>
</head>
<body>

<div class="container">
    <h1>üìù –ë–õ–ê–ù–ö –ú–û–ù–Ü–¢–û–†–ù–ò–ì–£ v7.4</h1>

    <div class="card">
        <div id="notifStatus" class="status-indicator status-off">–ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è: –í–ò–ú–ö–ù–ï–ù–û</div>
        <div class="control-grid">
            <input type="date" id="currentDate" onchange="loadDayData()" style="grid-column: span 2;">
            <button class="btn btn-orange" onclick="enableNotifications()">‚ñ∂ –£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫</button>
            <button class="btn btn-red" onclick="disableNotifications()">‚èπ –í–∏–º–∫–Ω—É—Ç–∏ –≤—Å–µ</button>
            <button class="btn btn-blue" onclick="setToday()" style="grid-column: span 2;">üìÖ –°—å–æ–≥–æ–¥–Ω—ñ</button>
        </div>
    </div>

    <div class="card" style="padding: 0; overflow: hidden;">
        <div style="overflow-x: auto;">
            <table class="main-table">
                <thead>
                    <tr>
                        <th style="width: 100px;">–ß–∞—Å –¥–æ–±–∏</th>
                        <th>–ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å</th>
                        <th style="width: 110px;">–î / –¢</th>
                        <th style="width: 80px;">–¥–æ—Å.</th>
                        <th style="width: 80px;">–∑–∞–¥.</th>
                    </tr>
                </thead>
                <tbody id="mainTableBody">
                    <tr><td>04.00-05.00</td><td><textarea id="act_04.00-05.00" class="activity-box" oninput="saveCurrentData()"></textarea></td><td><div style="display:flex;gap:4px;justify:center;"><input type="number" id="dep_04.00-05.00" class="num-input" oninput="saveCurrentData()"><input type="number" id="anx_04.00-05.00" class="num-input" oninput="saveCurrentData()"></div></td><td><input type="number" id="ach_04.00-05.00" class="num-input" oninput="saveCurrentData()"></td><td><input type="number" id="sat_04.00-05.00" class="num-input" oninput="saveCurrentData()"></td></tr>
                    <tr><td>05.00-06.00</td><td><textarea id="act_05.00-06.00" class="activity-box" oninput="saveCurrentData()"></textarea></td><td><div style="display:flex;gap:4px;justify:center;"><input type="number" id="dep_05.00-06.00" class="num-input" oninput="saveCurrentData()"><input type="number" id="anx_05.00-06.00" class="num-input" oninput="saveCurrentData()"></div></td><td><input type="number" id="ach_05.00-06.00" class="num-input" oninput="saveCurrentData()"></td><td><input type="number" id="sat_05.00-06.00" class="num-input" oninput="saveCurrentData()"></td></tr>
                    <tr><td>06.00-07.00</td><td><textarea id="act_06.00-07.00" class="activity-box" oninput="saveCurrentData()"></textarea></td><td><div style="display:flex;gap:4px;justify:center;"><input type="number" id="dep_06.00-07.00" class="num-input" oninput="saveCurrentData()"><input type="number" id="anx_06.00-07.00" class="num-input" oninput="saveCurrentData()"></div></td><td><input type="number" id="ach_06.00-07.00" class="num-input" oninput="saveCurrentData()"></td><td><input type="number" id="sat_06.00-07.00" class="num-input" oninput="saveCurrentData()"></td></tr>
                    <tr><td>07.00-08.00</td><td><textarea id="act_07.00-08.00" class="activity-box" oninput="saveCurrentData()"></textarea></td><td><div style="display:flex;gap:4px;justify:center;"><input type="number" id="dep_07.00-08.00" class="num-input" oninput="saveCurrentData()"><input type="number" id="anx_07.00-08.00" class="num-input" oninput="saveCurrentData()"></div></td><td><input type="number" id="ach_07.00-08.00" class="num-input" oninput="saveCurrentData()"></td><td><input type="number" id="sat_07.00-08.00" class="num-input" oninput="saveCurrentData()"></td></tr>
                    <tr><td>08.00-09.00</td><td><textarea id="act_08.00-09.00" class="activity-box" oninput="saveCurrentData()"></textarea></td><td><div style="display:flex;gap:4px;justify:center;"><input type="number" id="dep_08.00-09.00" class="num-input" oninput="saveCurrentData()"><input type="number" id="anx_08.00-09.00" class="num-input" oninput="saveCurrentData()"></div></td><td><input type="number" id="ach_08.00-09.00" class="num-input" oninput="saveCurrentData()"></td><td><input type="number" id="sat_08.00-09.00" class="num-input" oninput="saveCurrentData()"></td></tr>
                    <tr><td>09.00-10.00</td><td><textarea id="act_09.00-10.00" class="activity-box" oninput="saveCurrentData()"></textarea></td><td><div style="display:flex;gap:4px;justify:center;"><input type="number" id="dep_09.00-10.00" class="num-input" oninput="saveCurrentData()"><input type="number" id="anx_09.00-10.00" class="num-input" oninput="saveCurrentData()"></div></td><td><input type="number" id="ach_09.00-10.00" class="num-input" oninput="saveCurrentData()"></td><td><input type="number" id="sat_09.00-10.00" class="num-input" oninput="saveCurrentData()"></td></tr>
                    <tr><td>10.00-11.00</td><td><textarea id="act_10.00-11.00" class="activity-box" oninput="saveCurrentData()"></textarea></td><td><div style="display:flex;gap:4px;justify:center;"><input type="number" id="dep_10.00-11.00" class="num-input" oninput="saveCurrentData()"><input type="number" id="anx_10.00-11.00" class="num-input" oninput="saveCurrentData()"></div></td><td><input type="number" id="ach_10.00-11.00" class="num-input" oninput="saveCurrentData()"></td><td><input type="number" id="sat_10.00-11.00" class="num-input" oninput="saveCurrentData()"></td></tr>
                    <tr><td>11.00-12.00</td><td><textarea id="act_11.00-12.00" class="activity-box" oninput="saveCurrentData()"></textarea></td><td><div style="display:flex;gap:4px;justify:center;"><input type="number" id="dep_11.00-12.00" class="num-input" oninput="saveCurrentData()"><input type="number" id="anx_11.00-12.00" class="num-input" oninput="saveCurrentData()"></div></td><td><input type="number" id="ach_11.00-12.00" class="num-input" oninput="saveCurrentData()"></td><td><input type="number" id="sat_11.00-12.00" class="num-input" oninput="saveCurrentData()"></td></tr>
                    <tr><td>12.00-13.00</td><td><textarea id="act_12.00-13.00" class="activity-box" oninput="saveCurrentData()"></textarea></td><td><div style="display:flex;gap:4px;justify-content:center;"><input type="number" id="dep_12.00-13.00" class="num-input" oninput="saveCurrentData()"><input type="number" id="anx_12.00-13.00" class="num-input" oninput="saveCurrentData()"></div></td><td><input type="number" id="ach_12.00-13.00" class="num-input" oninput="saveCurrentData()"></td><td><input type="number" id="sat_12.00-13.00" class="num-input" oninput="saveCurrentData()"></td></tr>
                    <tr><td>13.00-14.00</td><td><textarea id="act_13.00-14.00" class="activity-box" oninput="saveCurrentData()"></textarea></td><td><div style="display:flex;gap:4px;justify:center;"><input type="number" id="dep_13.00-14.00" class="num-input" oninput="saveCurrentData()"><input type="number" id="anx_13.00-14.00" class="num-input" oninput="saveCurrentData()"></div></td><td><input type="number" id="ach_13.00-14.00" class="num-input" oninput="saveCurrentData()"></td><td><input type="number" id="sat_13.00-14.00" class="num-input" oninput="saveCurrentData()"></td></tr>
                    <tr><td>14.00-15.00</td><td><textarea id="act_14.00-15.00" class="activity-box" oninput="saveCurrentData()"></textarea></td><td><div style="display:flex;gap:4px;justify:center;"><input type="number" id="dep_14.00-15.00" class="num-input" oninput="saveCurrentData()"><input type="number" id="anx_14.00-15.00" class="num-input" oninput="saveCurrentData()"></div></td><td><input type="number" id="ach_14.00-15.00" class="num-input" oninput="saveCurrentData()"></td><td><input type="number" id="sat_14.00-15.00" class="num-input" oninput="saveCurrentData()"></td></tr>
                    <tr><td>15.00-16.00</td><td><textarea id="act_15.00-16.00" class="activity-box" oninput="saveCurrentData()"></textarea></td><td><div style="display:flex;gap:4px;justify:center;"><input type="number" id="dep_15.00-16.00" class="num-input" oninput="saveCurrentData()"><input type="number" id="anx_15.00-16.00" class="num-input" oninput="saveCurrentData()"></div></td><td><input type="number" id="ach_15.00-16.00" class="num-input" oninput="saveCurrentData()"></td><td><input type="number" id="sat_15.00-16.00" class="num-input" oninput="saveCurrentData()"></td></tr>
                    <tr><td>16.00-17.00</td><td><textarea id="act_16.00-17.00" class="activity-box" oninput="saveCurrentData()"></textarea></td><td><div style="display:flex;gap:4px;justify:center;"><input type="number" id="dep_16.00-17.00" class="num-input" oninput="saveCurrentData()"><input type="number" id="anx_16.00-17.00" class="num-input" oninput="saveCurrentData()"></div></td><td><input type="number" id="ach_16.00-17.00" class="num-input" oninput="saveCurrentData()"></td><td><input type="number" id="sat_16.00-17.00" class="num-input" oninput="saveCurrentData()"></td></tr>
                    <tr><td>17.00-18.00</td><td><textarea id="act_17.00-18.00" class="activity-box" oninput="saveCurrentData()"></textarea></td><td><div style="display:flex;gap:4px;justify:center;"><input type="number" id="dep_17.00-18.00" class="num-input" oninput="saveCurrentData()"><input type="number" id="anx_17.00-18.00" class="num-input" oninput="saveCurrentData()"></div></td><td><input type="number" id="ach_17.00-18.00" class="num-input" oninput="saveCurrentData()"></td><td><input type="number" id="sat_17.00-18.00" class="num-input" oninput="saveCurrentData()"></td></tr>
                    <tr><td>18.00-19.00</td><td><textarea id="act_18.00-19.00" class="activity-box" oninput="saveCurrentData()"></textarea></td><td><div style="display:flex;gap:4px;justify:center;"><input type="number" id="dep_18.00-19.00" class="num-input" oninput="saveCurrentData()"><input type="number" id="anx_18.00-19.00" class="num-input" oninput="saveCurrentData()"></div></td><td><input type="number" id="ach_18.00-19.00" class="num-input" oninput="saveCurrentData()"></td><td><input type="number" id="sat_18.00-19.00" class="num-input" oninput="saveCurrentData()"></td></tr>
                    <tr><td>19.00-20.00</td><td><textarea id="act_19.00-20.00" class="activity-box" oninput="saveCurrentData()"></textarea></td><td><div style="display:flex;gap:4px;justify:center;"><input type="number" id="dep_19.00-20.00" class="num-input" oninput="saveCurrentData()"><input type="number" id="anx_19.00-20.00" class="num-input" oninput="saveCurrentData()"></div></td><td><input type="number" id="ach_19.00-20.00" class="num-input" oninput="saveCurrentData()"></td><td><input type="number" id="sat_19.00-20.00" class="num-input" oninput="saveCurrentData()"></td></tr>
                    <tr><td>20.00-21.00</td><td><textarea id="act_20.00-21.00" class="activity-box" oninput="saveCurrentData()"></textarea></td><td><div style="display:flex;gap:4px;justify:center;"><input type="number" id="dep_20.00-21.00" class="num-input" oninput="saveCurrentData()"><input type="number" id="anx_20.00-21.00" class="num-input" oninput="saveCurrentData()"></div></td><td><input type="number" id="ach_20.00-21.00" class="num-input" oninput="saveCurrentData()"></td><td><input type="number" id="sat_20.00-21.00" class="num-input" oninput="saveCurrentData()"></td></tr>
                    <tr><td>21.00-22.00</td><td><textarea id="act_21.00-22.00" class="activity-box" oninput="saveCurrentData()"></textarea></td><td><div style="display:flex;gap:4px;justify:center;"><input type="number" id="dep_21.00-22.00" class="num-input" oninput="saveCurrentData()"><input type="number" id="anx_21.00-22.00" class="num-input" oninput="saveCurrentData()"></div></td><td><input type="number" id="ach_21.00-22.00" class="num-input" oninput="saveCurrentData()"></td><td><input type="number" id="sat_21.00-22.00" class="num-input" oninput="saveCurrentData()"></td></tr>
                    <tr><td>22.00-23.00</td><td><textarea id="act_22.00-23.00" class="activity-box" oninput="saveCurrentData()"></textarea></td><td><div style="display:flex;gap:4px;justify:center;"><input type="number" id="dep_22.00-23.00" class="num-input" oninput="saveCurrentData()"><input type="number" id="anx_22.00-23.00" class="num-input" oninput="saveCurrentData()"></div></td><td><input type="number" id="ach_22.00-23.00" class="num-input" oninput="saveCurrentData()"></td><td><input type="number" id="sat_22.00-23.00" class="num-input" oninput="saveCurrentData()"></td></tr>
                    <tr><td>23.00-24.00</td><td><textarea id="act_23.00-24.00" class="activity-box" oninput="saveCurrentData()"></textarea></td><td><div style="display:flex;gap:4px;justify:center;"><input type="number" id="dep_23.00-24.00" class="num-input" oninput="saveCurrentData()"><input type="number" id="anx_23.00-24.00" class="num-input" oninput="saveCurrentData()"></div></td><td><input type="number" id="ach_23.00-24.00" class="num-input" oninput="saveCurrentData()"></td><td><input type="number" id="sat_23.00-24.00" class="num-input" oninput="saveCurrentData()"></td></tr>
                    <tr><td>24.00-01.00</td><td><textarea id="act_24.00-01.00" class="activity-box" oninput="saveCurrentData()"></textarea></td><td><div style="display:flex;gap:4px;justify:center;"><input type="number" id="dep_24.00-01.00" class="num-input" oninput="saveCurrentData()"><input type="number" id="anx_24.00-01.00" class="num-input" oninput="saveCurrentData()"></div></td><td><input type="number" id="ach_24.00-01.00" class="num-input" oninput="saveCurrentData()"></td><td><input type="number" id="sat_24.00-01.00" class="num-input" oninput="saveCurrentData()"></td></tr>
                    <tr><td>01.00-02.00</td><td><textarea id="act_01.00-02.00" class="activity-box" oninput="saveCurrentData()"></textarea></td><td><div style="display:flex;gap:4px;justify:center;"><input type="number" id="dep_01.00-02.00" class="num-input" oninput="saveCurrentData()"><input type="number" id="anx_01.00-02.00" class="num-input" oninput="saveCurrentData()"></div></td><td><input type="number" id="ach_01.00-02.00" class="num-input" oninput="saveCurrentData()"></td><td><input type="number" id="sat_01.00-02.00" class="num-input" oninput="saveCurrentData()"></td></tr>
                    <tr><td>02.00-03.00</td><td><textarea id="act_02.00-03.00" class="activity-box" oninput="saveCurrentData()"></textarea></td><td><div style="display:flex;gap:4px;justify:center;"><input type="number" id="dep_02.00-03.00" class="num-input" oninput="saveCurrentData()"><input type="number" id="anx_02.00-03.00" class="num-input" oninput="saveCurrentData()"></div></td><td><input type="number" id="ach_02.00-03.00" class="num-input" oninput="saveCurrentData()"></td><td><input type="number" id="sat_02.00-03.00" class="num-input" oninput="saveCurrentData()"></td></tr>
                    <tr><td>03.00-04.00</td><td><textarea id="act_03.00-04.00" class="activity-box" oninput="saveCurrentData()"></textarea></td><td><div style="display:flex;gap:4px;justify:center;"><input type="number" id="dep_03.00-04.00" class="num-input" oninput="saveCurrentData()"><input type="number" id="anx_03.00-04.00" class="num-input" oninput="saveCurrentData()"></div></td><td><input type="number" id="ach_03.00-04.00" class="num-input" oninput="saveCurrentData()"></td><td><input type="number" id="sat_03.00-04.00" class="num-input" oninput="saveCurrentData()"></td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <h3>‚ú® 3 –∫–æ–º–ø–ª—ñ–º–µ–Ω—Ç–∏ —Å–æ–±—ñ:</h3>
        <input type="text" id="comp_1" oninput="saveCurrentData()" placeholder="1.">
        <input type="text" id="comp_2" oninput="saveCurrentData()" placeholder="2.">
        <input type="text" id="comp_3" oninput="saveCurrentData()" placeholder="3.">
    </div>

    <div class="card">
        <h3>üìä –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∑–≤—ñ—Ç—É</h3>
        <div class="control-grid">
            <input type="date" id="exportFrom">
            <input type="date" id="exportTo">
        </div>
        <div class="control-grid" style="margin-top: 15px;">
            <button class="btn btn-blue" onclick="exportToWord()">üìÑ Word (.docx)</button>
            <button class="btn btn-orange" onclick="exportToHTML()">üåê HTML-–∑–≤—ñ—Ç</button>
        </div>
    </div>
</div>

<script>
    const STORAGE_KEY = 'kpt_v74_final_';
    const hours = ["04.00-05.00", "05.00-06.00", "06.00-07.00", "07.00-08.00", "08.00-09.00", "09.00-10.00", "10.00-11.00", "11.00-12.00", "12.00-13.00", "13.00-14.00", "14.00-15.00", "15.00-16.00", "16.00-17.00", "17.00-18.00", "18.00-19.00", "19.00-20.00", "20.00-21.00", "21.00-22.00", "22.00-23.00", "23.00-24.00", "24.00-01.00", "01.00-02.00", "02.00-03.00", "03.00-04.00"];
    let timerId = null;

    window.onload = () => {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('currentDate').value = today;
        document.getElementById('exportFrom').value = today;
        document.getElementById('exportTo').value = today;
        loadDayData();
    };

    function triggerAlert() {
        if ("vibrate" in navigator) navigator.vibrate([1000, 500, 1000, 500, 1000]);
        try {
            const context = new (window.AudioContext || window.webkitAudioContext)();
            const now = context.currentTime;
            const play = (t) => {
                const o = context.createOscillator();
                const g = context.createGain();
                o.connect(g); g.connect(context.destination);
                o.type = "sawtooth"; o.frequency.value = 880;
                g.gain.setValueAtTime(0.1, t);
                o.start(t); o.stop(t + 1);
            };
            play(now); play(now + 1.2); play(now + 2.4);
        } catch(e) {}
    }

    function enableNotifications() {
        Notification.requestPermission();
        localStorage.setItem('notifs_active', 'true');
        if(timerId) clearInterval(timerId);
        timerId = setInterval(() => {
            if(new Date().getMinutes() === 0) {
                triggerAlert();
                new Notification("–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ üìù", { body: "–ß–∞—Å –∑–∞–ø–æ–≤–Ω–∏—Ç–∏ –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å!" });
            }
        }, 60000);
        document.getElementById('notifStatus').className = "status-indicator status-on";
        document.getElementById('notifStatus').innerText = "–ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è: –£–í–Ü–ú–ö–ù–ï–ù–û";
    }

    function disableNotifications() {
        clearInterval(timerId);
        localStorage.setItem('notifs_active', 'false');
        document.getElementById('notifStatus').className = "status-indicator status-off";
    }

    function saveCurrentData() {
        const date = document.getElementById('currentDate').value;
        const data = { act: {}, mood: {}, ach: {}, sat: {}, comp: [document.getElementById('comp_1').value, document.getElementById('comp_2').value, document.getElementById('comp_3').value] };
        hours.forEach(h => {
            data.act[h] = document.getElementById(`act_${h}`).value;
            data.mood[h] = { d: document.getElementById(`dep_${h}`).value, t: document.getElementById(`anx_${h}`).value };
            data.ach[h] = document.getElementById(`ach_${h}`).value;
            data.sat[h] = document.getElementById(`sat_${h}`).value;
        });
        localStorage.setItem(STORAGE_KEY + date, JSON.stringify(data));
    }

    function loadDayData() {
        const date = document.getElementById('currentDate').value;
        const saved = JSON.parse(localStorage.getItem(STORAGE_KEY + date) || '{}');
        hours.forEach(h => {
            document.getElementById(`act_${h}`).value = saved.act?.[h] || '';
            document.getElementById(`dep_${h}`).value = saved.mood?.[h]?.d || '';
            document.getElementById(`anx_${h}`).value = saved.mood?.[h]?.t || '';
            document.getElementById(`ach_${h}`).value = saved.ach?.[h] || '';
            document.getElementById(`sat_${h}`).value = saved.sat?.[h] || '';
        });
        document.getElementById('comp_1').value = saved.comp?.[0] || '';
        document.getElementById('comp_2').value = saved.comp?.[1] || '';
        document.getElementById('comp_3').value = saved.comp?.[2] || '';
    }

    function setToday() { document.getElementById('currentDate').value = new Date().toISOString().split('T')[0]; loadDayData(); }

    async function exportToWord() {
        const cmToDxa = (cm) => Math.round(cm * 566.9);
        const start = new Date(document.getElementById('exportFrom').value);
        const end = new Date(document.getElementById('exportTo').value);
        const allDates = [];
        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) { allDates.push(new Date(d).toISOString().split('T')[0]); }

        const sections = [];
        for (let i = 0; i < allDates.length; i += 3) {
            const pageDates = allDates.slice(i, i + 3);
            const pageData = pageDates.map(d => ({ date: d, data: JSON.parse(localStorage.getItem(STORAGE_KEY + d) || '{}') }));

            const headerRow = new docx.TableRow({
                height: { value: cmToDxa(3), type: docx.HeightRule.EXACT },
                children: [
                    new docx.TableCell({ width: { size: cmToDxa(2.3), type: docx.WidthType.DXA }, shading: { fill: "F2F2F2" }, verticalAlign: docx.VerticalAlign.CENTER, children: [new docx.Paragraph({ children: [new docx.TextRun({ text: "–ß–∞—Å –¥–æ–±–∏", bold: true, font: "Times New Roman", size: 24 })], alignment: docx.AlignmentType.CENTER })] }),
                    ...pageDates.map(d => {
                        const dateObj = new Date(d);
                        const days = ['–ù–¥','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'];
                        const dateString = `–î–µ–Ω—å: ${d.split('-').reverse().join('.')} (${days[dateObj.getDay()]})`;
                        return [
                            new docx.TableCell({ width: { size: cmToDxa(5.6), type: docx.WidthType.DXA }, shading: { fill: "F2F2F2" }, verticalAlign: docx.VerticalAlign.CENTER, children: [new docx.Paragraph({ children: [new docx.TextRun({ text: dateString, bold: true, font: "Times New Roman", size: 24 })], alignment: docx.AlignmentType.CENTER })] }),
                            new docx.TableCell({ width: { size: cmToDxa(1.25), type: docx.WidthType.DXA }, shading: { fill: "F2F2F2" }, verticalAlign: docx.VerticalAlign.CENTER, children: [new docx.Paragraph({ children: [new docx.TextRun({ text: "–î/—Ç 0-10", bold: true, font: "Times New Roman", size: 22 })], alignment: docx.AlignmentType.CENTER })] }),
                            new docx.TableCell({ width: { size: cmToDxa(0.75), type: docx.WidthType.DXA }, shading: { fill: "F2F2F2" }, verticalAlign: docx.VerticalAlign.CENTER, textDirection: docx.TextDirection.BOTTOM_TO_TOP_LEFT_TO_RIGHT, children: [new docx.Paragraph({ children: [new docx.TextRun({ text: "–¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è", bold: true, font: "Times New Roman", size: 24 })], alignment: docx.AlignmentType.CENTER })] }),
                            new docx.TableCell({ width: { size: cmToDxa(0.75), type: docx.WidthType.DXA }, shading: { fill: "F2F2F2" }, verticalAlign: docx.VerticalAlign.CENTER, textDirection: docx.TextDirection.BOTTOM_TO_TOP_LEFT_TO_RIGHT, children: [new docx.Paragraph({ children: [new docx.TextRun({ text: "–∑–∞–¥–æ–≤–æ–ª–µ–Ω–Ω—è", bold: true, font: "Times New Roman", size: 24 })], alignment: docx.AlignmentType.CENTER })] })
                        ];
                    }).flat()
                ]
            });

            const rows = [headerRow];
            hours.forEach(h => {
                const cells = [new docx.TableCell({ children: [new docx.Paragraph({ text: h, font: "Times New Roman", size: 20, alignment: docx.AlignmentType.CENTER })] })];
                pageData.forEach(p => {
                    cells.push(new docx.TableCell({ children: [new docx.Paragraph({ text: p.data.act?.[h] || "", font: "Times New Roman", size: 20 })] }));
                    cells.push(new docx.TableCell({ children: [new docx.Paragraph({ text: p.data.mood?.[h] ? `${p.data.mood[h].d}/${p.data.mood[h].t}` : "/ ", font: "Times New Roman", size: 20, alignment: docx.AlignmentType.CENTER })] }));
                    cells.push(new docx.TableCell({ children: [new docx.Paragraph({ text: p.data.ach?.[h] || "", font: "Times New Roman", size: 20, alignment: docx.AlignmentType.CENTER })] }));
                    cells.push(new docx.TableCell({ children: [new docx.Paragraph({ text: p.data.sat?.[h] || "", font: "Times New Roman", size: 20, alignment: docx.AlignmentType.CENTER })] }));
                });
                while(cells.length < 13) cells.push(new docx.TableCell({ children: [] }));
                rows.push(new docx.TableRow({ children: cells }));
            });

            const compRow = new docx.TableRow({
                children: [
                    new docx.TableCell({ children: [] }),
                    ...pageData.map(p => [
                        new docx.TableCell({ children: [
                            new docx.Paragraph({ children: [new docx.TextRun({ text: "3 –∫–æ–º–ø–ª—ñ–º–µ–Ω—Ç–∏ —Å–æ–±—ñ:", font: "Times New Roman", size: 20 })] }),
                            new docx.Paragraph({ children: [new docx.TextRun({ text: `1. ${p.data.comp?.[0] || ""}`, font: "Times New Roman", size: 20 })] }),
                            new docx.Paragraph({ children: [new docx.TextRun({ text: `2. ${p.data.comp?.[1] || ""}`, font: "Times New Roman", size: 20 })] }),
                            new docx.Paragraph({ children: [new docx.TextRun({ text: `3. ${p.data.comp?.[2] || ""}`, font: "Times New Roman", size: 20 })] })
                        ] }),
                        new docx.TableCell({ children: [] }), new docx.TableCell({ children: [] }), new docx.TableCell({ children: [] })
                    ]).flat()
                ]
            });
            while(compRow.root[1].length < 13) compRow.root[1].push(new docx.TableCell({ children: [] }));
            rows.push(compRow);

            sections.push({
                properties: { page: { size: { width: cmToDxa(29.7), height: cmToDxa(21) }, margin: { top: cmToDxa(0.75), bottom: cmToDxa(0.5), right: cmToDxa(1), left: cmToDxa(1) } } },
                children: [
                    new docx.Paragraph({ children: [new docx.TextRun({ text: "–ë–õ–ê–ù–ö –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π", bold: true, font: "Times New Roman", size: 28 })], alignment: docx.AlignmentType.CENTER, spacing: { after: 120 } }),
                    new docx.Table({ width: { size: cmToDxa(27.35), type: docx.WidthType.DXA }, rows: rows })
                ]
            });
        }

        const doc = new docx.Document({ sections });
        docx.Packer.toBlob(doc).then(blob => {
            const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
            a.download = `Monitoring_v7.4.docx`; a.click();
        });
    }

    function exportToHTML() {
        const start = new Date(document.getElementById('exportFrom').value);
        const end = new Date(document.getElementById('exportTo').value);
        const allDates = [];
        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) { allDates.push(new Date(d).toISOString().split('T')[0]); }

        let html = `<html><head><meta charset="UTF-8"><style>
            @page { size: A4 landscape; margin: 0.75cm 1cm 0.5cm 1cm; }
            body { font-family: 'Times New Roman', serif; margin: 0; padding: 1cm; background: #fff; }
            .page-break { page-break-after: always; }
            h1 { text-align: center; font-size: 28px; margin-bottom: 0.5cm; }
            table { width: 100%; border-collapse: collapse; table-layout: fixed; }
            td, th { border: 1px solid #000; padding: 4px; text-align: center; font-size: 11pt; overflow: hidden; }
            .header { background: #F2F2F2; font-weight: bold; font-size: 12pt; height: 3cm; }
            .vert { writing-mode: vertical-rl; transform: rotate(180deg); }
            .time-col { width: 2.3cm; }
            .day-col { width: 5.6cm; text-align: left; }
            .dt-col { width: 1.25cm; }
            .score-col { width: 0.75cm; }
            .comp-box { text-align: left; font-size: 10pt; }
        </style></head><body>`;

        for (let i = 0; i < allDates.length; i += 3) {
            const pageDates = allDates.slice(i, i + 3);
            const pageData = pageDates.map(d => JSON.parse(localStorage.getItem(STORAGE_KEY + d) || '{}'));

            html += `<h1>–ë–õ–ê–ù–ö –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π</h1><table><thead><tr class="header">
                <th class="time-col">–ß–∞—Å –¥–æ–±–∏</th>`;
            
            pageDates.forEach(d => {
                const dateObj = new Date(d);
                const days = ['–ù–¥','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'];
                html += `<th class="day-col">–î–µ–Ω—å: ${d.split('-').reverse().join('.')} (${days[dateObj.getDay()]})</th>
                         <th class="dt-col">–î/—Ç 0-10</th>
                         <th class="score-col"><div class="vert">–¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è</div></th>
                         <th class="score-col"><div class="vert">–∑–∞–¥–æ–≤–æ–ª–µ–Ω–Ω—è</div></th>`;
            });
            
            // –ó–∞–≥–ª—É—à–∫–∏ –¥–ª—è –ø–æ—Ä–æ–∂–Ω—ñ—Ö —Å—Ç–æ–≤–ø—Ü—ñ–≤
            for(let j = pageDates.length; j < 3; j++) html += `<th class="day-col"></th><th class="dt-col"></th><th class="score-col"></th><th class="score-col"></th>`;
            
            html += `</tr></thead><tbody>`;

            hours.forEach(h => {
                html += `<tr><td>${h}</td>`;
                pageData.forEach(data => {
                    html += `<td class="day-col">${data.act?.[h] || ''}</td>
                             <td>${data.mood?.[h] ? `${data.mood[h].d}/${data.mood[h].t}` : '/ '}</td>
                             <td>${data.ach?.[h] || ''}</td>
                             <td>${data.sat?.[h] || ''}</td>`;
                });
                for(let j = pageData.length; j < 3; j++) html += `<td></td><td></td><td></td><td></td>`;
                html += `</tr>`;
            });

            // –†—è–¥–æ–∫ –∫–æ–º–ø–ª—ñ–º–µ–Ω—Ç—ñ–≤
            html += `<tr><td></td>`;
            pageData.forEach(data => {
                html += `<td class="comp-box"><b>3 –∫–æ–º–ø–ª—ñ–º–µ–Ω—Ç–∏ —Å–æ–±—ñ:</b><br>1. ${data.comp?.[0] || ''}<br>2. ${data.comp?.[1] || ''}<br>3. ${data.comp?.[2] || ''}</td><td></td><td></td><td></td>`;
            });
            html += `</tr></tbody></table><div class="page-break"></div>`;
        }

        html += `</body></html>`;
        const blob = new Blob([html], { type: 'text/html' });
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
        a.download = `Monitoring_Report.html`; a.click();
    }
</script>
</body>
</html>
